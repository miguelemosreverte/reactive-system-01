# =============================================================================
# Platform Configuration (HOCON)
# =============================================================================
# This is the single source of truth for all platform settings.
# Environment variables override these defaults: ${?ENV_VAR}
#
# Usage in Java:
#   Config config = PlatformConfig.load();
#   int heap = config.getMemorySize("services.application.memory.heap").toMegabytes();
#
# Usage for Docker generation:
#   ./cli.sh config generate docker-compose
# =============================================================================

platform {
  # Total memory budget for the platform (used for validation)
  total-memory = 8g
  total-memory = ${?PLATFORM_TOTAL_MEMORY}

  # ==========================================================================
  # Service Memory Configuration
  # ==========================================================================
  # Each service has:
  #   - container: Docker memory limit
  #   - heap: JVM -Xmx (for Java) or GOMEMLIMIT (for Go)
  #   - description: What this service does
  # ==========================================================================

  services {

    # --------------------------------------------------------------------------
    # Core Pipeline Services
    # --------------------------------------------------------------------------

    application {
      description = "Main counter application (Spring WebFlux + Kafka producer)"
      memory {
        container = 1536m
        heap = 1g
      }
      jvm {
        options = [
          "-XX:+UseG1GC"
          "-XX:MaxGCPauseMillis=100"
          "-XX:+UseStringDeduplication"
        ]
      }
    }

    gateway {
      description = "HTTP gateway for external traffic"
      memory {
        container = 512m
        heap = 384m
      }
    }

    flink-jobmanager {
      description = "Flink cluster coordinator"
      memory {
        container = 768m
        process-size = 640m  # taskmanager.memory.process.size
      }
    }

    flink-taskmanager {
      description = "Flink stream processing worker"
      memory {
        container = 1408m
        process-size = 1280m  # taskmanager.memory.process.size
      }
      parallelism = 4
      async-capacity = 250
    }

    drools {
      description = "Business rules engine"
      memory {
        container = 512m
        heap = 384m
      }
    }

    # --------------------------------------------------------------------------
    # Message Broker
    # --------------------------------------------------------------------------

    kafka {
      description = "Message broker (Confluent)"
      memory {
        container = 1280m
        heap = 1g
      }
      topics {
        events = "counter-events"
        results = "counter-results"
        alerts = "counter-alerts"
      }
      producer {
        batch-size = 65536      # 64KB
        linger-ms = 5
        buffer-memory = 67108864  # 64MB
        compression = "lz4"
        acks = 1
      }
    }

    # --------------------------------------------------------------------------
    # Observability Stack
    # --------------------------------------------------------------------------

    otel-collector {
      description = "OpenTelemetry collector (traces, metrics, logs)"
      memory {
        container = 128m
        go-memlimit = 100m
      }
    }

    jaeger {
      description = "Distributed tracing backend"
      memory {
        container = 96m
        go-memlimit = 64m
      }
    }

    prometheus {
      description = "Metrics storage and query"
      memory {
        container = 640m
      }
      retention = "15d"
      scrape-interval = 15s
    }

    loki {
      description = "Log aggregation"
      memory {
        container = 256m
      }
    }

    promtail {
      description = "Log collector agent"
      memory {
        container = 96m
      }
    }

    grafana {
      description = "Observability dashboards"
      memory {
        container = 128m
      }
    }

    cadvisor {
      description = "Container metrics exporter"
      memory {
        container = 96m
      }
    }

    # --------------------------------------------------------------------------
    # UI
    # --------------------------------------------------------------------------

    ui {
      description = "React dashboard (nginx)"
      memory {
        container = 32m
      }
    }
  }

  # ==========================================================================
  # Benchmark Thresholds
  # ==========================================================================
  # Used by dogfooding workflow: commits rejected if below thresholds

  benchmark {
    # Minimum acceptable throughput (ops/sec)
    min-throughput = 10000
    min-throughput = ${?BENCHMARK_MIN_THROUGHPUT}

    # Maximum acceptable p99 latency (ms)
    max-p99-latency = 50
    max-p99-latency = ${?BENCHMARK_MAX_P99_LATENCY}

    # Warmup configuration
    warmup-duration = 3s
    measurement-duration = 5s

    # Concurrency
    concurrent-clients = 8
  }

  # ==========================================================================
  # Network Configuration
  # ==========================================================================

  network {
    # Ports exposed to host
    ports {
      gateway = 3000
      ui = 8080
      grafana = 3001
      prometheus = 9090
      jaeger = 16686
    }

    # Internal Docker network
    docker-network = "reactive-network"
  }

  # ==========================================================================
  # Profiles
  # ==========================================================================
  # Override defaults for specific environments

  profiles {
    # Minimal memory for CI/testing
    ci {
      services.application.memory.container = 768m
      services.application.memory.heap = 512m
      services.kafka.memory.container = 768m
      services.kafka.memory.heap = 512m
      services.flink-taskmanager.memory.container = 1024m
      services.flink-taskmanager.memory.process-size = 896m
    }

    # Production settings (more headroom)
    production {
      services.application.memory.container = 2g
      services.application.memory.heap = 1536m
      services.kafka.memory.container = 2g
      services.kafka.memory.heap = 1536m
      services.prometheus.memory.container = 1g
    }
  }
}
