# =============================================================================
# Platform Configuration (HOCON)
# =============================================================================
# This is the single source of truth for all platform settings.
# Environment variables override these defaults: ${?ENV_VAR}
#
# Usage in Java:
#   Config config = PlatformConfig.load();
#   int heap = config.getMemorySize("services.application.memory.heap").toMegabytes();
#
# Usage for Docker generation:
#   ./cli.sh config generate docker-compose
# =============================================================================

platform {
  # Total memory budget for the platform (used for validation)
  total-memory = 8g
  total-memory = ${?PLATFORM_TOTAL_MEMORY}

  # ==========================================================================
  # Service Memory Configuration
  # ==========================================================================
  # Each service has:
  #   - container: Docker memory limit
  #   - heap: JVM -Xmx (for Java) or GOMEMLIMIT (for Go)
  #   - description: What this service does
  # ==========================================================================

  services {

    # --------------------------------------------------------------------------
    # Core Pipeline Services
    # --------------------------------------------------------------------------

    application {
      description = "Main counter application (Spring WebFlux + Kafka producer)"
      memory {
        container = 1536m
        heap = 1g
      }
      jvm {
        options = [
          "-XX:+UseG1GC"
          "-XX:MaxGCPauseMillis=100"
          "-XX:+UseStringDeduplication"
        ]
      }
    }

    gateway {
      description = "HTTP gateway for external traffic"
      memory {
        container = 512m
        heap = 384m
      }
    }

    flink-jobmanager {
      description = "Flink cluster coordinator"
      memory {
        container = 768m
        process-size = 640m  # taskmanager.memory.process.size
      }
    }

    flink-taskmanager {
      description = "Flink stream processing worker"
      memory {
        container = 1408m
        process-size = 1280m  # taskmanager.memory.process.size
      }
      parallelism = 4
      async-capacity = 250
    }

    drools {
      description = "Business rules engine"
      memory {
        container = 512m
        heap = 384m
      }
    }

    # --------------------------------------------------------------------------
    # Message Broker
    # --------------------------------------------------------------------------

    kafka {
      description = "Message broker (Confluent)"
      memory {
        container = 1280m
        heap = 1g
      }
      topics {
        events = "counter-events"
        results = "counter-results"
        alerts = "counter-alerts"
      }
      producer {
        batch-size = 65536      # 64KB
        linger-ms = 5
        buffer-memory = 67108864  # 64MB
        compression = "lz4"
        acks = 1
      }
    }

    # --------------------------------------------------------------------------
    # Observability Stack
    # --------------------------------------------------------------------------

    otel-collector {
      description = "OpenTelemetry collector (traces, metrics, logs)"
      memory {
        container = 128m
        go-memlimit = 100m
      }
    }

    jaeger {
      description = "Distributed tracing backend"
      memory {
        container = 96m
        go-memlimit = 64m
      }
    }

    prometheus {
      description = "Metrics storage and query"
      memory {
        container = 640m
      }
      retention = "15d"
      scrape-interval = 15s
    }

    loki {
      description = "Log aggregation"
      memory {
        container = 256m
      }
    }

    promtail {
      description = "Log collector agent"
      memory {
        container = 96m
      }
    }

    grafana {
      description = "Observability dashboards"
      memory {
        container = 128m
      }
    }

    cadvisor {
      description = "Container metrics exporter"
      memory {
        container = 96m
      }
    }

    # --------------------------------------------------------------------------
    # UI
    # --------------------------------------------------------------------------

    ui {
      description = "React dashboard (nginx)"
      memory {
        container = 32m
      }
    }
  }

  # ==========================================================================
  # Benchmark Thresholds
  # ==========================================================================
  # Used by dogfooding workflow: commits rejected if below thresholds

  benchmark {
    # Minimum acceptable throughput (ops/sec)
    min-throughput = 10000
    min-throughput = ${?BENCHMARK_MIN_THROUGHPUT}

    # Maximum acceptable p99 latency (ms)
    max-p99-latency = 50
    max-p99-latency = ${?BENCHMARK_MAX_P99_LATENCY}

    # Warmup configuration
    warmup-duration = 3s
    measurement-duration = 5s

    # Concurrency
    concurrent-clients = 8
  }

  # ==========================================================================
  # Kafka Benchmark Configuration
  # ==========================================================================
  # Settings for high-throughput Kafka benchmarks and batchers

  kafka-benchmark {
    # Message configuration
    message-size = 64                # bytes

    # Benchmark durations (seconds)
    durations {
      smoke = 3                      # Quick validation (<5s)
      quick = 15                     # Development testing
      thorough = 60                  # Final validation
      brochure-total = 300           # 5 minute brochure
      brochure-ramp = 240            # 4 minute ramp-up
      brochure-sustain = 60          # 1 minute sustained max
    }

    # Warmup counts
    warmup {
      messages-naive = 10000         # Warmup for naive producer
      batches-bulk = 100             # Warmup for bulk producer
    }

    # Producer batch sizes (bytes)
    batch-size {
      small = 16384                  # 16KB - low latency
      standard = 262144              # 256KB - balanced
      large = 1048576                # 1MB - high throughput
      max = 16777216                 # 16MB - extreme throughput
    }

    # Producer buffer memory (bytes)
    buffer-memory {
      standard = 134217728           # 128MB
      large = 536870912              # 512MB
    }

    # Producer settings
    producer {
      fetch-max-bytes = 52428800     # 50MB - max consumer fetch
      max-request-size = 104857600   # 100MB - max producer request
      compression = "lz4"
      linger-ms-high-throughput = 100
      linger-ms-low-latency = 0
      linger-ms-fire-and-forget = 5
    }

    # Batcher configuration
    batcher {
      threshold-standard = 16384     # 16KB - flush threshold
      interval-ms = 100              # Standard flush interval
    }
  }

  # ==========================================================================
  # Publisher Defaults
  # ==========================================================================
  # Default settings for KafkaPublisher builder

  publisher {
    # Default producer settings
    max-in-flight-requests = 5
    linger-ms = 0
    batch-size = 16384               # 16KB
    buffer-memory = 16777216         # 16MB
    compression = "none"
    acks = "1"
    estimated-message-size = 64      # bytes, for batch sizing

    # Fire-and-forget mode (high throughput, no guarantees)
    fire-and-forget {
      max-in-flight-requests = 100
      linger-ms = 0
      batch-size = 65536             # 64KB
      compression = "none"
      acks = "0"
    }

    # High-throughput mode (balanced)
    high-throughput {
      max-in-flight-requests = 10
      linger-ms = 5
      batch-size = 131072            # 128KB
      buffer-memory = 134217728      # 128MB
      compression = "lz4"
      acks = "1"
    }
  }

  # ==========================================================================
  # Network Configuration
  # ==========================================================================

  network {
    # Ports exposed to host
    ports {
      gateway = 3000
      ui = 8080
      grafana = 3001
      prometheus = 9090
      jaeger = 16686
    }

    # Internal Docker network
    docker-network = "reactive-network"
  }

  # ==========================================================================
  # Profiles
  # ==========================================================================
  # Override defaults for specific environments

  profiles {
    # Minimal memory for CI/testing
    ci {
      services.application.memory.container = 768m
      services.application.memory.heap = 512m
      services.kafka.memory.container = 768m
      services.kafka.memory.heap = 512m
      services.flink-taskmanager.memory.container = 1024m
      services.flink-taskmanager.memory.process-size = 896m
    }

    # Production settings (more headroom)
    production {
      services.application.memory.container = 2g
      services.application.memory.heap = 1536m
      services.kafka.memory.container = 2g
      services.kafka.memory.heap = 1536m
      services.prometheus.memory.container = 1g
    }
  }
}
